# Packaging & Build

## electron-builder: Keep as devDependency

**DO NOT use `pnpm dlx` for electron-builder.** It has 300+ sub-dependencies, making `pnpm dlx` download them all on every invocation — extremely slow and impractical.

Always install electron and electron-builder as devDependencies:

```json
{
  "devDependencies": {
    "electron": "^35.7.5",
    "electron-builder": "^26.8.0"
  },
  "scripts": {
    "start": "electron .",
    "build": "electron-builder --mac",
    "build:dir": "electron-builder --mac --dir"
  }
}
```

## Shared Modules with extraResources

When multiple Electron apps share common code (e.g., a `shared/electron-app-core/` module), use `extraResources` in electron-builder config — NOT the `files` glob.

### Why NOT `files` glob

```json
// WRONG - files glob with ../ paths does NOT work reliably
"files": [
  "main.js",
  "../../../shared/electron-app-core/**/*"
]
```

The shared module won't be included in the asar, causing "Cannot find module" at runtime.

### Correct: extraResources

```json
// CORRECT - copies shared module to app's Resources directory
"files": ["main.js", "app-config.js", "splash.html", "package.json"],
"extraResources": [
  {
    "from": "../../../shared/electron-app-core",
    "to": "electron-app-core"
  }
]
```

### Dual-path Resolution in main.js

The shared module path differs between development and packaged mode:

```javascript
const { app } = require('electron');
const path = require('path');

function getSharedCorePath() {
  if (app.isPackaged) {
    // Packaged: extraResources copies to Resources/electron-app-core/
    return path.join(process.resourcesPath, 'electron-app-core');
  }
  // Development: relative path to shared directory
  return path.join(__dirname, '..', '..', '..', 'shared', 'electron-app-core');
}

const { setupMenu, createWindowManager } = require(getSharedCorePath());
```

## Dynamic Project Root Resolution

Packaged apps need to find their project root (for spawning dev servers). Avoid hardcoding paths — they break when worktrees or directories change.

### Resolution Order

1. **Saved config** — user previously selected a path (persisted to `~/.config/<app>/config.json`)
2. **Walk up from exe** — walk up directory tree from the app executable, matching `package.json` name
3. **Default path** — hardcoded fallback
4. **User prompt** — show folder picker dialog as last resort

### Walk Up from Exe Path (Preferred)

Instead of counting a fixed number of `..` levels (fragile — breaks if directory structure changes), walk up the directory tree and check each level for the project marker:

```javascript
const PROJECT_PACKAGE_NAME = "my-project-name";

function isProjectRoot(dir) {
  try {
    const pkgPath = path.join(dir, "package.json");
    if (!fs.existsSync(pkgPath)) return false;
    const pkg = JSON.parse(fs.readFileSync(pkgPath, "utf-8"));
    return pkg.name === PROJECT_PACKAGE_NAME;
  } catch {
    return false;
  }
}

function findProjectRootFromExePath() {
  let dir = path.dirname(app.getPath("exe"));
  const root = path.parse(dir).root;

  while (dir !== root) {
    if (isProjectRoot(dir)) {
      return dir;
    }
    dir = path.dirname(dir);
  }
  return null;
}
```

This works when the `.app` is anywhere inside the repo tree (e.g. `electron-app/dist/mac-arm64/`). If the user copies the `.app` outside the repo, it falls through to saved config or user prompt.

The `isProjectRoot` helper can also be reused in the folder-picker validation to avoid duplicating the check.

## Gitignore for Electron Apps

electron-builder creates build artifacts that should not be committed:

```gitignore
# Electron app build artifacts
**/electron-app*/dist/
**/electron-app*/package-lock.json
```

The `package-lock.json` files are generated by electron-builder's internal `npm install` step during packaging.
