# Packaging & Build

## electron-builder with pnpm dlx

Use `pnpm dlx` to avoid installing electron/electron-builder as project dependencies.

### pnpm 10 Compatibility

pnpm 10 introduces strict security checks that break `pnpm dlx` for Electron packages. Required flags:

```bash
pnpm --config.trustPolicy=accept --config.strictDepBuilds=false dlx \
  --package=electron@36 --package=electron-builder@26 \
  electron-builder --mac -c.electronVersion=36.9.5
```

- `--config.trustPolicy=accept` — bypasses `ERR_PNPM_TRUST_DOWNGRADE` for packages that lost provenance attestation
- `--config.strictDepBuilds=false` — bypasses `ERR_PNPM_IGNORED_BUILDS` for dependency build scripts (e.g., electron postinstall)
- `-c.electronVersion=36.9.5` — explicit electron version, required because `pnpm dlx` creates isolated environments where electron-builder can't auto-detect the electron version from node_modules

### package.json Scripts

```json
{
  "scripts": {
    "start": "pnpm --config.trustPolicy=accept dlx electron@36 .",
    "build": "pnpm --config.trustPolicy=accept --config.strictDepBuilds=false dlx --package=electron@36 --package=electron-builder@26 electron-builder --mac -c.electronVersion=36.9.5",
    "build:dir": "pnpm --config.trustPolicy=accept --config.strictDepBuilds=false dlx --package=electron@36 --package=electron-builder@26 electron-builder --mac --dir -c.electronVersion=36.9.5"
  }
}
```

## Shared Modules with extraResources

When multiple Electron apps share common code (e.g., a `shared/electron-app-core/` module), use `extraResources` in electron-builder config — NOT the `files` glob.

### Why NOT `files` glob

```json
// WRONG - files glob with ../ paths does NOT work reliably
"files": [
  "main.js",
  "../../../shared/electron-app-core/**/*"
]
```

The shared module won't be included in the asar, causing "Cannot find module" at runtime.

### Correct: extraResources

```json
// CORRECT - copies shared module to app's Resources directory
"files": ["main.js", "app-config.js", "splash.html", "package.json"],
"extraResources": [
  {
    "from": "../../../shared/electron-app-core",
    "to": "electron-app-core"
  }
]
```

### Dual-path Resolution in main.js

The shared module path differs between development and packaged mode:

```javascript
const { app } = require('electron');
const path = require('path');

function getSharedCorePath() {
  if (app.isPackaged) {
    // Packaged: extraResources copies to Resources/electron-app-core/
    return path.join(process.resourcesPath, 'electron-app-core');
  }
  // Development: relative path to shared directory
  return path.join(__dirname, '..', '..', '..', 'shared', 'electron-app-core');
}

const { setupMenu, createWindowManager } = require(getSharedCorePath());
```

## Dynamic Project Root Resolution

Packaged apps need to find their project root (for spawning dev servers). Avoid hardcoding paths — they break when worktrees or directories change.

### Resolution Order

1. **Saved config** — user previously selected a path (persisted to `~/.config/<app>/config.json`)
2. **App exe location** — walk up from the app's executable path to find the project
3. **Default path** — hardcoded fallback
4. **User prompt** — show folder picker dialog as last resort

### Resolving from App Location

In packaged macOS apps, the executable lives at:
```
<electron-app-dir>/dist/mac-arm64/<App>.app/Contents/MacOS/<App>
```

Walk up 7 levels from the exe to reach the project root (1 level above the electron-app dir):

```javascript
function resolveFromAppLocation(config) {
  try {
    const exePath = app.getPath('exe');
    const projectDir = path.resolve(exePath, '..', '..', '..', '..', '..', '..', '..');
    const packageJsonPath = path.join(projectDir, 'package.json');
    if (fs.existsSync(packageJsonPath)) {
      const pkg = JSON.parse(fs.readFileSync(packageJsonPath, 'utf-8'));
      if (pkg.name === config.projectName) {
        return projectDir;
      }
    }
  } catch {
    // App may have been moved from build location
  }
  return null;
}
```

This works when the app is run from its build location within the repo. If the user copies the `.app` elsewhere, it falls through to saved config or user prompt.

## Gitignore for Electron Apps

electron-builder creates build artifacts that should not be committed:

```gitignore
# Electron app build artifacts
**/electron-app*/dist/
**/electron-app*/package-lock.json
```

The `package-lock.json` files are generated by electron-builder's internal `npm install` step during packaging.
