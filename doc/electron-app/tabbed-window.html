<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Claude Code Doc</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      html, body {
        height: 100%;
        overflow: hidden;
      }

      body {
        display: flex;
        flex-direction: column;
        background: #1e1e1e;
      }

      /* Make the tab group fill the window */
      tab-group {
        display: flex;
        flex-direction: column;
        flex: 1;
        height: 100%;
        --tabgroup-background: #1e1e1e;
        --tab-font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        --tab-font-size: 13px;
        --tab-background: #2d2d2d;
        --tab-color: #cccccc;
        --tab-border-color: #3c3c3c;
        --tab-active-background: #3c3c3c;
        --tab-active-color: #ffffff;
        --tab-hover-background: #383838;
        --button-background: transparent;
        --button-color: #cccccc;
        --button-hover-background: #3c3c3c;
      }
    </style>
  </head>
  <body>
    <tab-group new-tab-button="true" sortable="true" theme="dark"></tab-group>

    <script src="node_modules/electron-tabs/dist/electron-tabs.js"></script>
    <script>
      const { ipcRenderer } = require("electron");

      const defaultUrl = "http://claude.localhost:9987";
      const tabGroup = document.querySelector("tab-group");

      // Wait for tab-group to be ready
      tabGroup.on("ready", () => {
        // Add initial tab
        addTab(defaultUrl);
      });

      // Set default tab configuration
      tabGroup.setDefaultTab({
        title: "New Tab",
        src: defaultUrl,
        active: true,
      });

      function addTab(url) {
        const tab = tabGroup.addTab({
          title: "Loading...",
          src: url || defaultUrl,
          active: true,
        });

        // Function to update title
        function updateTitle(webview, tab) {
          const title = webview.getTitle();
          if (title && title !== "" && title !== "Loading...") {
            tab.setTitle(title);
            return true;
          }
          return false;
        }

        // Update tab title when webview is ready
        tab.once("webview-ready", (tab) => {
          const webview = tab.webview;
          if (webview) {
            // Listen for title changes
            webview.addEventListener("page-title-updated", (e) => {
              tab.setTitle(e.title);
            });

            // Try to get title after page loads
            webview.addEventListener("did-finish-load", () => {
              updateTitle(webview, tab);
            });

            // Fallback: poll for title if page already loaded
            let attempts = 0;
            const checkTitle = setInterval(() => {
              attempts++;
              if (updateTitle(webview, tab) || attempts > 20) {
                clearInterval(checkTitle);
              }
            }, 250);
          }
        });

        return tab;
      }

      // Listen for menu commands
      ipcRenderer.on("menu-new-tab", () => {
        addTab(defaultUrl);
      });

      ipcRenderer.on("menu-close-tab", () => {
        const activeTab = tabGroup.getActiveTab();
        if (activeTab) {
          activeTab.close();
          // If no tabs left, close window
          if (tabGroup.getTabs().length === 0) {
            window.close();
          }
        }
      });

      // Go to specific tab by index (0-indexed, visual order)
      ipcRenderer.on("menu-goto-tab", (event, index) => {
        // Get tab by visual position (1-indexed in electron-tabs)
        const tab = tabGroup.getTabByPosition(index);
        if (tab) {
          tab.activate();
        }
      });

      // Copy current URL to clipboard (Cmd+Option+C)
      ipcRenderer.on("copy-current-url", () => {
        const activeTab = tabGroup.getActiveTab();
        if (activeTab && activeTab.webview) {
          const url = activeTab.webview.getURL();
          if (url) {
            require("electron").clipboard.writeText(url);
          }
        }
      });

    </script>
  </body>
</html>
