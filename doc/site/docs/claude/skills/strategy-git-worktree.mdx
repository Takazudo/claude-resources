---
title: "strategy-git-worktree"
description: "Parallel multi-topic development using git worktrees with a base branch strategy and Claude Code agent teams. Use when: (1) User wants to work on multiple related features in parallel, (2) User mentio..."
---

# strategy-git-worktree



# Git Worktree Multi-Topic Development

Coordinate parallel development of multiple related features using git worktrees, a shared base branch, and Claude Code agent teams. **This is fully automated** — you (the manager) create the infrastructure and spawn child agents to do the work. Never ask the user to manually start sessions in worktrees.

## Architecture

```
<parent-branch> (the branch you branch from — could be main, develop, or a feature branch)
  └── base/<project-name>  (base branch, created by manager)
        ├── <project-name>/topicA  (child branch → PR into base)
        ├── <project-name>/topicB  (child branch → PR into base)
        └── <project-name>/topicC  (child branch → PR into base)

worktrees/
  ├── <topicA>/  (worktree for topicA, child agent works here)
  ├── <topicB>/  (worktree for topicB, child agent works here)
  └── <topicC>/  (worktree for topicC, child agent works here)
```

Each topic gets its own worktree directory, its own branch, and its own PR targeting the base branch. The manager merges topic PRs into the base branch, then creates one root PR from base into the parent branch.

## Fully Automated Workflow

**IMPORTANT**: You are the manager. You handle ALL steps automatically:
1. Create base branch + root PR
2. Create worktrees for each topic
3. Set up environment in worktrees
4. Use TeamCreate + Task tool to spawn child agents in worktrees
5. Monitor child agents, review their PRs, merge into base
6. Update root PR and mark ready
7. Clean up worktrees and branches

**Never ask the user to manually cd into worktrees or start Claude sessions.** Use the Task tool to spawn agents that work in each worktree directory.

### Step 1: Create Base Branch and Root PR

The base branch is created from whichever branch is the "parent" — this is often `main` or `develop`, but can also be a feature branch.

**CRITICAL**: Create the root PR immediately with an empty commit. This locks in the correct parent branch from the start.

```bash
# Ensure parent branch is up to date
git checkout <parent-branch>
git pull origin <parent-branch>

# Create the base branch
git checkout -b base/<project-name>

# Create empty start commit and push
git commit --allow-empty -m "= start <project-name> dev ="
git push -u origin base/<project-name>

# Create the root PR immediately (draft, targeting parent branch)
gh pr create \
  --base <parent-branch> \
  --title "<project-name>: root PR title" \
  --body "$(cat <<'EOF'
## Summary
(in progress)

## Topic PRs
(to be added as topics are completed)
EOF
)" \
  --draft
```

Save the root PR number — you will update it as topics are merged.

### Step 2: Create Worktrees

For each topic:

```bash
# Create worktree with a topic branch based on the base branch
git worktree add worktrees/<topic-name> -b <project-name>/<topic-name> base/<project-name>
```

Example with 3 topics:
```bash
git worktree add worktrees/topicA -b marker-fix/topicA base/marker-fix
git worktree add worktrees/topicB -b marker-fix/topicB base/marker-fix
git worktree add worktrees/topicC -b marker-fix/topicC base/marker-fix
```

### Step 3: Environment Setup (if needed)

If the project has environment files, symlink them into each worktree:

```bash
for wt in worktrees/*/; do
  ln -sf "$(pwd)/.env" "$wt/.env" 2>/dev/null
  # Add project-specific symlinks as needed (e.g., metadata, generated files)
done
```

If using pnpm workspaces, install dependencies in each worktree:

```bash
for wt in worktrees/*/; do
  (cd "$wt" && pnpm install)
done
```

### Step 4: Spawn Child Agents via Teams

Use TeamCreate to create a team, then use the Task tool to spawn child agents — one per topic. Each agent works in its own worktree directory.

```
1. TeamCreate with team_name: "<project-name>"
2. TaskCreate for each topic (implementation tasks)
3. Task tool to spawn agents with:
   - subagent_type: "frontend-worktree-child" (or "general-purpose" for non-frontend topics)
   - team_name: "<project-name>"
   - name: "topic-<name>"  (e.g., "topic-topicA")
   - prompt: Detailed instructions including:
     a. The worktree absolute path to work in
     b. What to implement for this topic
     c. Branch name: <project-name>/<topic-name>
     d. Base branch: base/<project-name>
     e. Instructions to commit, push, and create PR targeting base branch
     f. PR creation command: gh pr create --base base/<project-name>
```

**Spawn all child agents in parallel** using multiple Task tool calls in a single message. Each agent should:
1. Work in its assigned worktree directory
2. Implement the topic
3. Commit and push changes
4. Create a PR targeting `base/&lt;project-name&gt;`
5. Report back when done

### Step 5: Review and Merge Topic PRs

As child agents complete work and create PRs, **merge each topic PR via GitHub** (not command-line merge). This keeps the PR marked as "Merged" and avoids stale open PRs.

```bash
# Review each topic PR
gh pr view <pr-number>
gh pr diff <pr-number>

# Merge topic PRs into base branch (regular merge, not squash)
gh pr merge <pr-number>
```

**IMPORTANT**: Do not skip merging PRs. If topic work is merged directly into the base branch without going through the PR, close the PR explicitly: `gh pr close &lt;pr-number&gt; --comment "Merged outside PR"`. Leaving PRs open with deleted branches causes confusion.

### Step 6: Update Root PR and Mark Ready

After all topics are merged, update the root PR with the final summary and mark it ready for review.

```bash
# Update the root PR body with merged topic details
gh pr edit <root-pr-number> --body "$(cat <<'EOF'
## Summary
- Merged topicA: description
- Merged topicB: description
- Merged topicC: description

## Topic PRs
- #N topicA
- #N topicB
- #N topicC
EOF
)"

# Mark ready for review (remove draft status)
gh pr ready <root-pr-number>
```

### Step 7: Shutdown Team and Cleanup

After the root PR is merged:

```bash
# Send shutdown to all agents, then TeamDelete

# Remove worktrees
for wt in worktrees/*/; do
  git worktree remove "$wt"
done

# Delete local and remote topic branches
git branch -d <project-name>/topicA <project-name>/topicB <project-name>/topicC
git push origin --delete <project-name>/topicA <project-name>/topicB <project-name>/topicC

# Delete base branch
git branch -d base/<project-name>
git push origin --delete base/<project-name>
```

## Branch Naming Conventions

| Type | Pattern | Example |
|------|---------|---------|
| Base branch | `base/&lt;project&gt;` | `base/marker-fix` |
| Topic branch | `&lt;project&gt;/&lt;topic&gt;` | `marker-fix/bogaudio-knobs` |
| Worktree dir | `worktrees/&lt;topic&gt;` | `worktrees/bogaudio-knobs` |

## Important Rules

1. **Fully autonomous** — never ask the user to manually start sessions or cd into worktrees. Use Task tool to spawn agents
2. **Always pull the parent branch before creating the base branch** — stale bases cause conflicts
3. **Create the root PR immediately in Step 1** — an empty commit + draft PR locks in the correct parent branch
4. **Never force push** — regular merge only, preserves history
5. **Topic PRs target the base branch**, not the parent branch
6. **Root PR targets the parent branch** — this is handled automatically by creating it in Step 1
7. **worktrees/ must be in .gitignore** — worktrees are local only
8. **Manager stays at repo root** — never cd into worktrees for git ops
9. **Each child agent works in its worktree** — git ops affect that branch only
10. **Always merge PRs before cleanup** — never leave topic PRs or the root PR open. The full flow is: merge topic PRs → update root PR → merge root PR → then cleanup

## Prerequisites

- `worktrees/` in `.gitignore`
- `gh` CLI authenticated
- `git` version 2.15+ (worktree support)

